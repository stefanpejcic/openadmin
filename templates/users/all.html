<!-- users/ass.html -->
{% extends 'base.html' %}

{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD" crossorigin="anonymous">

<style>
.suspended-user-row {
  //background-color: #f4c6cb;
  background-color: rgba(var(--tblr-secondary-rgb),.08);
  border-left: .25rem var(--tblr-border-style) red;
}

/* Styles specific to dark theme */
body[data-bs-theme="dark"] .suspended-user-row {
  background-color: rgb(68, 55, 57);
}

.people-item {
  padding:1em;
}



.toggle-on-hover:hover .first {
  display: none;
}

.toggle-on-hover:hover .second {
  display: inline!important;
}

</style>  


{% if users %}

      <div class="page-wrapper">
        <!-- Page header -->
<div class="page-header mt-0 d-print-none">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <!-- Page pre-title -->
                <div class="page-pretitle">
                  OpenPanel
                </div>
                <h2 class="page-title">
                  Users
                </h2>
              </div>
              <!-- Page title actions -->
              <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                  <span class="d-none d-sm-inline">
                    
                      <div class="input-icon">
                        <span class="input-icon-addon">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path><path d="M21 21l-6 -6"></path></svg>
                        </span>
                        <input type="text" id="userSearchInput" class="form-control" placeholder="Search users…" aria-label="Search in website">

                      </div>
                  </span>



                  <a href="/user/new" class="btn btn-primary d-sm-inline-block">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 5l0 14"></path><path d="M5 12l14 0"></path></svg>New User</a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Page body -->
        <div class="page-body">
          <div class="container-xl">
              <div class="col-12">
                <div class="card">
                  <div class="table-responsive">
                    <table id="exiting_users"
		class="table table-vcenter table-mobile-md card-table">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th data-bs-toggle="tooltip" data-bs-placement="top" title="IPv4 that can be used by account to access services and domains.">IP Address</th>

                          <th>Limits</th>
                          <th>Usage</th>
                          <th>Plan</th>
                          <th>Setup Date</th>
                          <th>Owner</th>
                          <th class="w-1"></th>
                        </tr>
                      </thead>
                      <tbody>
                {% for user in users %}
    {% if "SUSPENDED_" in user[1] %}
        <tr class="suspended-user-row" data-username="{{ user[1].split('_')[-1] }}" data-email="{{ user[3] }}" style="vertical-align: middle;">
    {% else %}
        <tr style="vertical-align: middle;" data-username="{{ user[1] }}" data-email="{{ user[3] }}">
    {% endif %}
                          <td data-label="Name" >
                            <div class="d-flex py-1 align-items-center">
                            <a href="/users/{{ user[1] }}">
                              <span class="avatar me-2" style="background-image: url({{ gravatar_url(user[3], 150) }})" alt="Gravatar">
                                    {% if "SUSPENDED_" in user[1] %}
                                    <span class="badge bg-red"></span>
                                    {% endif %}
                                </span>
                            </a>
                              <div class="flex-fill">
                                <div class="font-weight-medium">
                                    <a href="/users/{{ user[1] }}"{% if "SUSPENDED_" in user[1] %} style="color: red;"{% endif %}>
                                    {{ user[1].split('_')[-1] }}</a> 
                                    {% if "SUSPENDED_" in user[1] %}
                                        <span class="badge bg-red-lt">SUSPENDED</span>
                                    {% endif %}
                                    </div>
                                <div class="text-muted"><span class="text-reset">{{ user[3] }}</span></div>

                              </div>
                            </div>
                          </td>
                          <td data-label="IP Address">
                            <div class="public-ip">{{ public_ip }}</div>
                          </td>




                {% set stat = stats | selectattr("user", "equalto", user[1]) | list | first %}
                {% set du = disk.get(user[10]) %}


                          <td data-label="Limits">
                            <div class="container">
                                <div class="row">
                                    <div class="col-md-6 border-end">
                                        <p class="m-0"><span class="icon icon-tabler"><i class="bi bi-memory"></i></span> {{ user[16] }}</p>
                                        <p class="m-0"><span class="icon icon-tabler"><i class="bi bi-cpu"></i></span> {{ user[15] }} Core</p>
                                    </div>

                                    <div class="col-md-6">
                                        <p class="m-0"><span class="icon icon-tabler"><i class="bi bi-hdd"></i></span> {{ user[13] }}</p>
                                        {% set inodes = ( (user[14]|int / 1000000) | round(2) ) ~ 'M' if user[14] != 0 else '∞' %}
                                        <p class="m-0"><span class="icon icon-tabler"><i class="bi bi-hdd-stack"></i></span> {{inodes }}</p>
                                    </div>

                                </div>
                            </div>
                          </td>





                          <td data-label="Usage">

                            <div class="container">
                                <div class="row">
                                    <div class="col-md-6 border-end">
                {% if stat %}
{% set mem_usage = stat.stats.MemUsage.split(' / ') %}
{% set used_memory = mem_usage[0].replace('MiB', '').strip()|float %}
{% set total_memory = mem_usage[1].replace('MiB', '').strip()|float %}
{% set percent = (used_memory / total_memory) * 100 %}

<div class="m-0" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ stat.stats.MemUsage }}">
    <span class="icon icon-tabler"><i class="bi bi-memory"></i></span> {{ percent | round(2) }} %
    <div class="progress">
        <div class="progress-bar" role="progressbar" style="width: {{ percent }}%;" 
            aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
        </div>
    </div>
</div>


{% set percent = (stat.stats.CPUPerc|replace(" ", "")|replace("%", "")|float / user[15]|float) if user[15] != 0 else (stat.stats.CPUPerc|replace(" ", "")|replace("%", "")|float) %}


{% set percent_total = (100 * user[15]|float) if user[15] != 0 else 100 %}


<div class="m-0" data-bs-toggle="tooltip" data-bs-placement="top" title='{{ stat.stats.CPUPerc|replace(" ", "") }} / {{ percent_total }}%'>
  <span class="icon icon-tabler"><i class="bi bi-cpu"></i></span> {{ stat.stats.CPUPerc }}
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style='width: {{ percent }}%;' 
                        aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                  </div>

</div>
                {% else %}
<div class="m-0" data-bs-toggle="tooltip" data-bs-placement="top" title="No Memory usage data yet.">
    <span class="icon icon-tabler"><i class="bi bi-memory"></i></span> 0 %
    <div class="progress">
        <div class="progress-bar" role="progressbar" style="width: 0%;" 
            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        </div>
    </div>
</div>


<div class="m-0" data-bs-toggle="tooltip" data-bs-placement="top" title='No CPU usage data yet.'>
  <span class="icon icon-tabler"><i class="bi bi-cpu"></i></span> 0 %
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style='width: 0%;' 
                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                  </div>
</div>

                {% endif %}
</div>
<div class="col-md-6">
{% if du %}

{% set percent = ((du.disk_used / du.disk_hard) * 100) if du.disk_hard != 0 else 0 %}

<div class="m-0" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ du.disk_used }} / {{ du.disk_hard }}">
<span class="icon icon-tabler"><i class="bi bi-hdd"></i></span> {{ percent | round(2) }} %
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ percent }}%;" 
                        aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                  </div>
</div>

{% set percent = ((du.inodes_used / du.inodes_hard) * 100) if du.inodes_hard != 0 else 0 %}
<div class="m-0" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ du.inodes_used }} / {{ du.inodes_hard }}">
  <span class="icon icon-tabler"><i class="bi bi-hdd-stack"></i></span> {{ percent | round(2) }} %
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ percent }}%;" 
                        aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                  </div>
 </div>

                                    </div>

                                </div>
                            </div>

                {% else %}
                    No disk usage data available
                {% endif %}
                
                </td>



                          <td class="text-muted" data-label="Plan" >
                            <a href="/plans#{{ user[12] }}">{{ user[12] }}</a>
                          </td>

                        <td data-label="Date" >
                            <div class="text-muted">{{ user[9].strftime('%d.%m.%Y %H:%M') }}</div>
                          </td>

                        <td data-label="Owner" >
                            <div class="text-muted">{% if user[4] %}{{ user[4] }}{% endif %}</div>
                          </td>


                          <td>
                            <div class="btn-list flex-nowrap">
    {% if "SUSPENDED_" in user[1] %}  
<button data-bs-toggle="tooltip" data-bs-placement="top" title="Login is disbaled for suspended user" class="btn btn-disabled w-50"  disabled>
Login
 </button>     
    {% else %}
<a href="#" class="btn w-50 loginLink" user="{{ user[1] }}" target="_blank" data-bs-toggle="tooltip" data-bs-placement="top" title="Login as {{ user[1] }} into OpenPanel">
Login
 </a>
    {% endif %}
<a href="/users/{{ user[1] }}" class="btn w-50 btn-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="View and Edit user">Manage</a>
                            </div>
                          </td>
                        </tr>
                        {% endfor %}

                      </tbody>
                    </table>

<script>
    fetch('/json/ips')
        .then(response => response.json())
        .then(data => {
            {% for user in users %}
                (function() {
                    const username = "{{ user[1] }}";
                    const publicIP = "{{ public_ip }}";

                    if (data.hasOwnProperty(username)) {
                        const ip = data[username];
                        updatePublicIP(username, ip);
                    }
                })();
            {% endfor %}
        })
        .catch(error => console.error('Error fetching /json/ips:', error));
</script>  


                  </div>
                </div>
          </div>
        </div>




      </div>
    </div>






{% else %}

<div class="page page-center">
      <div class="container-tight py-4">
        <div class="empty">
          <div class="empty-header">No Users</div>
          <p class="empty-title">No users or the MySQL service is not running.</p>
          <p class="d-none empty-subtitle text-secondary">
          </p>
          <div class="empty-action">
            <a href="/user/new" id="addUserButton" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 5l0 14"></path><path d="M5 12l14 0"></path></svg>
              Create your first user
            </a>
          </div>
        </div>
      </div>
    </div>

{% endif %}


<script src="{{ url_for('static', filename='pages/users_all.js') }}?v=0.39" defer></script>
<script src="{{ url_for('static', filename='pages/users_both.js') }}?v=0.39" defer></script>


{% endblock %}
