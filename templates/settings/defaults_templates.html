{% extends 'base.html' %}

{% block content %}

<form method="POST">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

<div x-data="{ searchQuery: '' }">
    <div x-data="{ showSection: false }" class="border-b border-gray-200 bg-gray-50 p-4 dark:border-gray-800 dark:bg-gray-950 sm:p-6 lg:p-8">
        <header>
            <div class="flex flex-col gap-2 text-center sm:flex-row sm:items-center sm:justify-between sm:text-start">
                <div class="grow">
                    <h1 class="mb-1 text-xl font-bold">Edit Defaults Templates</h1>
                    <h2 class="text-sm font-medium text-slate-500">Edit defaults used for new OpenPanel user accounts.</h2>
                </div>
                <div class="flex flex-none items-center justify-center gap-2 rounded-sm px-2 sm:justify-end sm:bg-transparent sm:px-0">
                  <div x-data="validateAndSaveComponent()" x-init="init()" class="flex flex-col sm:flex-row gap-2">
                    <button
                      type="button"
                      x-text="validated ? 'Save' : (loading ? 'Validating...' : 'Validate')"
                      @click="validated ? $el.form.submit() : validate()"
                      :disabled="loading"
                      class="relative inline-flex items-center justify-center whitespace-nowrap rounded-md border px-3 py-2 text-center text-sm font-medium shadow-sm transition-all duration-100 ease-in-out disabled:pointer-events-none disabled:shadow-none outline outline-offset-2 outline-0 focus-visible:outline-2 outline-indigo-500 dark:outline-indigo-500 border-transparent text-white dark:text-gray-900 bg-indigo-600 dark:bg-indigo-500 hover:bg-indigo-500 dark:hover:bg-indigo-600 disabled:bg-indigo-100 disabled:text-gray-400 disabled:dark:bg-indigo-800 disabled:dark:text-indigo-400"
                    ></button>
                  </div>
                </div>
            </div>
        </header>
    </div>

  <div class="m-8">

<div class="grid grid-cols-1 gap-x-14 gap-y-8 md:grid-cols-3" x-data="restoreComponentFor('compose_file', 'https://raw.githubusercontent.com/stefanpejcic/openpanel-configuration/refs/heads/main/docker/compose/1.0/docker-compose.yml')">
    <div>
        <h2 id="compose" class="scroll-mt-10 font-semibold text-gray-900 dark:text-gray-50">docker-compose.yml</h2>
        <p class="mt-1 text-sm leading-6 text-gray-500">Set services, volumes and variables. <a href="https://dev.openpanel.com/images/" target="_blank" class="inline-flex items-center gap-1 text-indigo-600 hover:underline hover:underline-offset-4 dark:text-indigo-400">Learn more<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" aria-hidden="true" class="remixicon size-4 shrink-0"><path d="M10 6V8H5V19H16V14H18V20C18 20.5523 17.5523 21 17 21H4C3.44772 21 3 20.5523 3 20V7C3 6.44772 3.44772 6 4 6H10ZM21 3V11H19L18.9999 6.413L11.2071 14.2071L9.79289 12.7929L17.5849 5H13V3H21Z"></path></svg></a>
<br>

    <button
      type="button"
      @click="restoreDefault"
      class="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
      :disabled="loading">
      <template x-if="!loading"><span>Restore Default</span></template>
      <template x-if="loading">
        <svg class="animate-spin h-4 w-4 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
        </svg>
      </template>
    </button>

        </p>
    </div>
    <div class="md:col-span-2">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-6">

            <div class="col-span-full">
                <div class="relative w-full mt-2">

                    <div class="row form-selectgroup form-selectgroup-boxes d-flex">
                        <div class="mt-4 grid grid-cols-1 gap-4">
                            <textarea name="compose" id="compose_file" class="flex min-h-[4rem] w-full rounded-md border px-3 py-1.5 shadow-sm outline-none transition-colors sm:text-sm text-gray-900 dark:text-gray-50 border-gray-300 dark:border-gray-800 bg-white dark:bg-gray-950 placeholder-gray-400 dark:placeholder-gray-500 disabled:border-gray-300 disabled:bg-gray-100 disabled:text-gray-300 disabled:dark:border-gray-700 disabled:dark:bg-gray-800 disabled:dark:text-gray-500 focus:ring-2 focus:ring-blue-200 focus:dark:ring-blue-700/30 focus:border-blue-500 focus:dark:border-blue-700" rows="20" cols="50">{{ compose }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div class="mx-auto my-6 flex w-full items-center justify-between gap-3 text-sm text-gray-500 dark:text-gray-500"><div class="h-[1px] w-full bg-gray-200 dark:bg-gray-800"></div></div>

<div class="grid grid-cols-1 gap-x-14 gap-y-8 md:grid-cols-3" x-data="restoreComponentFor('env_file', 'https://raw.githubusercontent.com/stefanpejcic/openpanel-configuration/refs/heads/main/docker/compose/1.0/.env')">
    <div>
        <h2 id="env" class="scroll-mt-10 font-semibold text-gray-900 dark:text-gray-50">.env</h2>
        <p class="mt-1 text-sm leading-6 text-gray-500">Edit variables and default limits for services. <a href="https://dev.openpanel.com/images/" target="_blank" class="inline-flex items-center gap-1 text-indigo-600 hover:underline hover:underline-offset-4 dark:text-indigo-400">Learn more<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" aria-hidden="true" class="remixicon size-4 shrink-0"><path d="M10 6V8H5V19H16V14H18V20C18 20.5523 17.5523 21 17 21H4C3.44772 21 3 20.5523 3 20V7C3 6.44772 3.44772 6 4 6H10ZM21 3V11H19L18.9999 6.413L11.2071 14.2071L9.79289 12.7929L17.5849 5H13V3H21Z"></path></svg></a>
<br>
    <button
      type="button"
      @click="restoreDefault"
      class="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
      :disabled="loading">
      <template x-if="!loading"><span>Restore Default</span></template>
      <template x-if="loading">
        <svg class="animate-spin h-4 w-4 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
        </svg>
      </template>
    </button>
        </p>
    </div>
    <div class="md:col-span-2">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-6">

            <div class="col-span-full">
                <div class="relative w-full mt-2">

                    <div class="row form-selectgroup form-selectgroup-boxes d-flex">
                        <div class="mt-4 grid grid-cols-1 gap-4">
                            <textarea name="env" id="env_file" class="flex min-h-[4rem] w-full rounded-md border px-3 py-1.5 shadow-sm outline-none transition-colors sm:text-sm text-gray-900 dark:text-gray-50 border-gray-300 dark:border-gray-800 bg-white dark:bg-gray-950 placeholder-gray-400 dark:placeholder-gray-500 disabled:border-gray-300 disabled:bg-gray-100 disabled:text-gray-300 disabled:dark:border-gray-700 disabled:dark:bg-gray-800 disabled:dark:text-gray-500 focus:ring-2 focus:ring-blue-200 focus:dark:ring-blue-700/30 focus:border-blue-500 focus:dark:border-blue-700" rows="20" cols="50">{{ env }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> 

</div>        
    
</div>
</form>



<script>
function restoreComponentFor(id, githubFile) {
  return {
    loading: false,
    async restoreDefault() {
      this.loading = true;
      try {
        const res = await fetch(githubFile);
        if (!res.ok) throw new Error('Failed to fetch default configuration from GitHub');
        const text = await res.text();
        const textarea = document.getElementById(id);
        if (textarea) textarea.value = text;
      } catch (e) {
        showToast(e.message, 'danger');
      } finally {
        this.loading = false;
      }
    }
  }
}
</script>

<script>
function validateAndSaveComponent() {
  return {
    validated: false,
    loading: false,
    init() {
      this.watchForEdits();
    },
    async validate() {
      this.loading = true;
      this.validated = false;
      try {
        const env = document.getElementById('env_file').value;
        const compose = document.getElementById('compose_file').value;
        const formData = new FormData();
        formData.append('env', env);
        formData.append('compose', compose);

        const res = await fetch('/settings/defaults/files', {
          method: 'PUT',
          body: formData,
          headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
          },
        });

        const result = await res.json();

        if (res.ok && result.success) {
          this.validated = true;
          showToast(`Validation passed. You can now save.`, 'success');
        } else {
          console.error(result);
          showToast('Validation failed:\n' + (result.stderr || JSON.stringify(result)), 'warning');
        }
      } catch (err) {
        showToast('Unexpected error: ' + err.message, 'danger');
      } finally {
        this.loading = false;
      }
    },
    watchForEdits() {
      const textareas = [document.getElementById('env_file'), document.getElementById('compose_file')];
      textareas.forEach(el => {
        if (el) {
          el.addEventListener('input', () => {
            this.validated = false;
          });
        }
      });
    }
  }
}
</script>

{% endblock %}
