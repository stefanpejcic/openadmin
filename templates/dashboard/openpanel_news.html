<!-- Content of custom_message.html using TailwindCSS -->

<style>
    .dismiss-custom_message-button {
        display: none;
    }
    #custom_message:hover .dismiss-custom_message-button {
        display: inline-block;
    }
</style>

<div class="">
    <div id="custom_message" class="">
                <form action="{{ url_for('dismiss_dashboard_widget', template_name='openpanel_news') }}" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="p-6 flex flex-col gap-2 text-center sm:flex-row sm:items-center sm:justify-between sm:text-start border-b border-gray-200 px-6 dark:border-gray-900"><div><h3 class="font-medium text-gray-900 dark:text-gray-50">Latest News <button class="dismiss-custom_message-button relative inline-flex items-center justify-center rounded-md border px-2 text-center text-sm font-medium shadow-sm transition-all duration-100 ease-in-out disabled:pointer-events-none disabled:shadow-none outline outline-offset-2 outline-0 focus-visible:outline-2 outline-blue-500 dark:outline-blue-500 border-gray-300 dark:border-gray-800 text-gray-900 dark:text-gray-50 bg-white dark:bg-gray-950 hover:bg-gray-50 dark:hover:bg-gray-900/60 disabled:text-gray-400 disabled:dark:text-gray-600 w-full gap-x-0.5 whitespace-nowrap sm:w-fit" type="submit" title="Hide and never show news from openpanel.com/blog again">Dismiss</button></h3><p class="text-sm/6 text-gray-500 dark:text-gray-500">from the OpenPanel blog.</p></div></div>
                </form>

        <div class="overflow-auto mt-2 h-full" id="news-content"></div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const newsContent = document.getElementById('news-content');

    fetch('https://api.github.com/repos/stefanpejcic/OpenPanel/contents/website/blog')
        .then(response => response.json())
        .then(data => {
            const markdownFiles = data
                .filter(file => file.name.endsWith('.md'))
                .sort((a, b) => new Date(b.name.split('-').slice(0, 3).join('-')) - new Date(a.name.split('-').slice(0, 3).join('-')))
                .slice(0, 7);

            const fetchRequiredLines = async (fileUrl) => {
                const response = await fetch(fileUrl);
                const text = await response.text();
                const lines = text.split('\n');
                const title = lines.find(line => line.startsWith('title:'))?.replace('title:', '').trim() || 'No Title';
                const description = lines.find(line => line.startsWith('description:'))?.replace('description:', '').trim() || '';
                const slug = lines.find(line => line.startsWith('slug:'))?.replace('slug:', '').trim() || '';
                const image = lines.find(line => line.startsWith('image:'))?.replace('image:', '').trim() || '';
                return { title, description, slug, image };
            };

            const fetchAndDisplayContent = async (file) => {
                const fileUrl = `https://raw.githubusercontent.com/stefanpejcic/OpenPanel/main/website/blog/${file.name}`;
                const { title, description, slug, image } = await fetchRequiredLines(fileUrl);

                const newsItemDiv = document.createElement('div');
                newsItemDiv.classList.add('flex', 'items-center', 'py-2', 'border-b');

                if (image) {
                    const imageDiv = document.createElement('div');
                    imageDiv.classList.add('w-1/4', 'pr-3');
                    const imgLink = document.createElement('a');
                    imgLink.href = `https://openpanel.com/blog/${slug}`;
                    imgLink.target = '_blank';
                    const img = document.createElement('img');
                    img.src = image;
                    img.alt = title;
                    img.classList.add('rounded-lg', 'w-full');
                    imgLink.appendChild(img);
                    imageDiv.appendChild(imgLink);
                    newsItemDiv.appendChild(imageDiv);
                }

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('flex-1');
                const titleElement = document.createElement('h3');
                titleElement.classList.add('text-lg', 'font-semibold');
                const titleLink = document.createElement('a');
                titleLink.href = `https://openpanel.com/blog/${slug}`;
                titleLink.target = '_blank';
                titleLink.classList.add('text-sm', 'font-medium', 'text-gray-900', 'dark:text-gray-50', 'hover:underline');
                titleLink.textContent = title;
                titleElement.appendChild(titleLink);
                const descriptionElement = document.createElement('p');
                descriptionElement.classList.add('text-sm', 'capitalize', 'text-gray-600', 'dark:text-gray-400');
                descriptionElement.textContent = description;
                contentDiv.appendChild(titleElement);
                contentDiv.appendChild(descriptionElement);
                newsItemDiv.appendChild(contentDiv);
                newsContent.appendChild(newsItemDiv);
            };

            markdownFiles.forEach(file => {
                fetchAndDisplayContent(file);
            });
        })
        .catch(error => {
            console.error('Error fetching the GitHub API:', error);
            newsContent.innerHTML = '<p class="text-red-500">Error loading news</p>';
        });
});
</script>
