{% extends 'base.html' %}

{% block content %}

<style>
.suspended-user-row {
  //background-color: #f4c6cb;
  background-color: rgba(var(--tblr-secondary-rgb),.08);
  border-left: .25rem var(--tblr-border-style) red;
}

/* Styles specific to dark theme */
body[data-bs-theme="dark"] .suspended-user-row {
  background-color: rgb(68, 55, 57);
}

</style>  

<!-- Page header -->
<div class="page-header mt-0 d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <!-- Page pre-title -->
                <div class="page-pretitle">
                    Domains
                </div>
                <h2 class="page-title">
                    All Domains
                </h2>
            </div>
            <!-- Page title actions -->
            <div class="col-auto ms-auto mt-0 d-print-none">
                <div class="btn-list">

                    <a href="#" class="d-none btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-add-domain"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 5l0 14"></path><path d="M5 12l14 0"></path></svg>Add Domain</a>

               </div>
            </div>
        </div>
    </div>
</div>


<!-- Page body -->
<div class="page-body">
{% if domains %}
    <div class="">
        <div class="row row-deck row-cards">
            <div class="col-lg-12" id="domains">
                <div class="card-body p-0">
                    <div id="table-default" class="table-responsive">
                    <table class="table table-vcenter card-table table-striped">
                        <thead>
                        <tr>
                        <th><button class="table-sort" data-sort="sort-id" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Domain ID from the database" data-bs-original-title="Domain ID from the database">ID</button></th>
                        <th><button class="table-sort" data-sort="sort-url" >Domain Name</button></th>
                        <th><button class="table-sort" data-sort="sort-username" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="User that added the domain name" data-bs-original-title="User that added the domain name">Owner</button></th>
                        <th><button class="table-sort" data-sort="sort-status" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Is domain suspended or active" data-bs-original-title="Is domain suspended or active">Status</button></th>
                        <th><button class="table-sort" data-sort="sort-ssl" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Is the domain using SSL or not" data-bs-original-title="Is the domain using automatic SSL from OpenPanel">SSL</button></th>
                        <th data-bs-toggle="tooltip" data-bs-placement="top" aria-label="View and Edit domain configuration files" data-bs-original-title="View and Edit domain configuration files">Editors</th>
                        <th data-bs-toggle="tooltip" data-bs-placement="top" aria-label="View domain logs and generated reports" data-bs-original-title="View domain logs and generated reports">Analytics</th>
                        <th class="d-none">Advanced</th>
                        </tr>
                        </thead>
                        <tbody class="table-tbody">
                        {% for domain in domains %}

                        <tr {% if "SUSPENDED_" in domain.username %} class="suspended-user-row" {% endif %} data-domain="{{ domain.domain_url }}">
                        <td class="text-secondary sort-url">{{ domain.domain_id }}</td>
                        <td class="sort-id"><a href="http://{{ domain.domain_url }}" class="domain_name_in_table" target="_blank">{{ domain.domain_url }}</a></td>
                        <td class="sort-username"><a href="/users/{{ domain.username }}">{{ domain.username.split('_')[-1] }} {% if "SUSPENDED_" in domain.username %}<span class="badge bg-red-lt">SUSPENDED</span>{% endif %}
</a></td>

           <td class="sort-status">
            <span class="domain-status"><div class="placeholder placeholder-xs col-6"></div></span>
            </td>
 
            <td class="sort-ssl">
            <span class="domain-ssl"><div class="placeholder placeholder-xs col-6"></div></span>
            </td>

                        <td><a href="#" class="btn edit_dns_link" data-domain="{{ domain.domain_url }}" data-bs-toggle="offcanvas" data-bs-target="#dnsOffcanvas">
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-edit" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path><path d="M16 5l3 3"></path></svg> DNS Zone</a> <a href="#" class="btn edit_caddy_link" data-domain="{{ domain.domain_url }}" data-bs-toggle="offcanvas" data-bs-target="#caddyOffcanvas">
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-edit" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path><path d="M16 5l3 3"></path></svg> VirtualHosts</a></td>
                        <td><a href="#" class="view_log_link" data-domain="{{ domain.domain_url }}" data-bs-toggle="offcanvas" data-bs-target="#logOffcanvas"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-zoom-code" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /><path d="M8 8l-2 2l2 2" /><path d="M12 8l2 2l-2 2" /></svg> Access Log</a> | <a href="/domains/log/{{ domain.username }}/{{ domain.domain_url }}" target="_blank" class=""><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-world-www"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 7a9 9 0 0 0 -7.5 -4a8.991 8.991 0 0 0 -7.484 4" /><path d="M11.5 3a16.989 16.989 0 0 0 -1.826 4" /><path d="M12.5 3a16.989 16.989 0 0 1 1.828 4" /><path d="M19.5 17a9 9 0 0 1 -7.5 4a8.991 8.991 0 0 1 -7.484 -4" /><path d="M11.5 21a16.989 16.989 0 0 1 -1.826 -4" /><path d="M12.5 21a16.989 16.989 0 0 0 1.828 -4" /><path d="M2 10l1 4l1.5 -4l1.5 4l1 -4" /><path d="M17 10l1 4l1.5 -4l1.5 4l1 -4" /><path d="M9.5 10l1 4l1.5 -4l1.5 4l1 -4" /></svg> Visitors Report</a></td>
                        <td class="d-none"><a href="#" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Transfer {{ domain.domain_url }} to another user" data-bs-original-title="Transfer {{ domain.domain_url }} to another user" class="btn btn-outline-primary" data-domain="{{ domain.domain_url }}"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-shuffle"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 4l3 3l-3 3" /><path d="M18 20l3 -3l-3 -3" /><path d="M3 7h3a5 5 0 0 1 5 5a5 5 0 0 0 5 5h5" /><path d="M21 7h-5a4.978 4.978 0 0 0 -3 1m-4 8a4.984 4.984 0 0 1 -3 1h-3" /></svg> Transfer</a> <a href="#" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Remove {{ domain.domain_url }} from user {{ domain.username }}" data-bs-original-title="Remove {{ domain.domain_url }} from user {{ domain.username }}" class="btn btn-outline-danger" data-domain="{{ domain.domain_url }}"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-trash"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg> Remove</a></td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    // Iterate over each domain row
    document.querySelectorAll("tr[data-domain]").forEach(function (row) {
        const domain = row.querySelector(".domain_name_in_table").textContent.trim();

        const statusCell = row.querySelector(".sort-status");
        const suspensionStatusSpan = statusCell.querySelector(".domain-status");

        const sslCell = row.querySelector(".sort-ssl");
        const sslStatusSpan = sslCell.querySelector(".domain-ssl");

        // Fetch domain status
        fetch(`/domains/${domain}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {

                if (data.suspended_status === "Not Suspended") {
                    suspensionStatusSpan.innerHTML = `
                    <span class="badge bg-green-lt">Active</span>`;
                } else if (data.suspended_status === "Suspended") {
                    suspensionStatusSpan.innerHTML = `
                    <span class="badge bg-red-lt">Suspended</span>`;
                } else {
                    suspensionStatusSpan.innerHTML = `
                    <span class="badge bg-gray-lt">Unknown</span>`;
                }

                if (data.https_status === "Automatic") {
                    sslStatusSpan.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-lock-check">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M11.5 21h-4.5a2 2 0 0 1 -2 -2v-6a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v.5"/>
                            <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0"/>
                            <path d="M8 11v-4a4 4 0 1 1 8 0v4"/>
                            <path d="M15 19l2 2l4 -4"/>
                        </svg> Automatic TLS`;
                } else {
                    sslStatusSpan.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-lock-open">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5 11m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z"/>
                            <path d="M12 16m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/>
                            <path d="M8 11v-5a4 4 0 0 1 8 0"/>
                        </svg> Custom SSL`;
                }
            })
            .catch(error => {
                console.error("Error fetching domain data:", error);
                suspensionStatusSpan.textContent = "Error";
                sslStatusSpan.innerHTML = `
                    Error
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-lock-open">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M5 11m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z"/>
                        <path d="M12 16m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/>
                        <path d="M8 11v-5a4 4 0 0 1 8 0"/>
                    </svg>`;
            });
    });
});
</script>

<div class="offcanvas offcanvas-end" tabindex="-1" id="caddyOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="domain_name_caddy">Edit DNS</h5>
        <button id="saveCaddy" class="btn btn-primary mt-2">Save</button>
    </div>
    <div class="offcanvas-body" style="overflow-y: hidden;">
        <textarea id="caddyContent" rows="20" class="ql-container ql-snow" style="height:100%; width: 100%;"></textarea>
    </div>
</div>

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="logOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="log_domain_name">View log</h5>
    </div>
    <div class="offcanvas-body" style="overflow-y: hidden;padding:0px;">
        <pre id="logContent" rows="20" class="ql-container ql-snow" style="border-radius: 0px!important; height:100%; width: 100%; padding-bottom: 0;margin-bottom: 0;" disabled></pre>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="dnsOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="domain_name">Edit DNS</h5>
        <button id="saveDns" class="btn btn-primary mt-2">Save</button>
    </div>
    <div class="offcanvas-body" style="overflow-y: hidden;">
        <textarea id="dnsContent" rows="20" class="ql-container ql-snow" style="height:100%; width: 100%;"></textarea>
    </div>
</div>




<script>

// EDIT USER DNS FOR DOMAIN

$(document).ready(function() {
    var currentDomain;

    $('.edit_caddy_link').click(function(e) {
        e.preventDefault();
        currentDomain = $(this).data('domain');
        $.get(`/caddy-vhosts/${currentDomain}`, function(data) {
            $('#caddyContent').val(data.caddy_content);
            $('#domain_name_caddy').text(`Caddy vHosts for ${currentDomain}`);
            $('#caddyOffcanvas').addClass('show');
        });
    });

    $('#saveCaddy').click(function() {
        var newContent = $('#caddyContent').val();
        $.ajax({
            type: 'POST',
            url: `/save-vhosts/${currentDomain}`,
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({
                'new_content': newContent
            }),
            success: function(response) {
                alert('Caddy configuration saved successfully!');
            },
            error: function(error) {
                alert('Error saving Caddy configuration: ' + error.responseText);
            }
        });
    });


    $('#closeOffcanvasBtn').click(function() {
        $('#caddyOffcanvas').removeClass('show');
    });


    $(document).on('click', function(e) {
        if (!$(e.target).closest('.edit_caddy_link').length && !$(e.target).closest('#caddyOffcanvas').length) {
            $('#caddyOffcanvas').removeClass('show');
        }
    });
});



// SHOW USER DOMAIN CADDY ACCESS LOG

$(document).ready(function() {
    var currentDomain;

    $('.view_log_link').click(function(e) {
        e.preventDefault();
        currentDomain = $(this).data('domain');
        $.get(`/caddy-logs/${currentDomain}`, function(data) {
            $('#logContent').text(data.caddy_content).scrollTop($('#logContent')[0].scrollHeight);
            $('#log_domain_name').text(`Access Log for ${currentDomain}`);
            $('#logOffcanvas').addClass('show');
        });
    });

    $('#closeOffcanvasBtn').click(function() {
        $('#logOffcanvas').removeClass('show');
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest('.view_log_link').length && !$(e.target).closest('#logOffcanvas').length) {
            $('#logOffcanvas').removeClass('show');
        }
    });
});







// EDIT USER DNS ZONE
$(document).ready(function() {
    var currentDomain;

    $('.edit_dns_link').click(function(e) {
        e.preventDefault();

        currentDomain = $(this).data('domain');

        $.get(`/dns-bind/${currentDomain}`, function(data) {
            $('#dnsContent').val(data.bind_content);
            $('#domain_name').text(`Edit DNS for ${currentDomain}`);
            $('#dnsOffcanvas').addClass('show');
        });
    });

    $('#saveDns').click(function() {
        var newContent = $('#dnsContent').val();

        $.ajax({
            type: 'POST',
            url: `/save-dns/${currentDomain}`,
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({
                'new_content': newContent
            }),
            success: function(response) {
                alert('DNS content saved successfully!');
            },
            error: function(error) {
                alert('Error saving DNS content: ' + error.responseText);
            }
        });
    });


    $('#closeOffcanvasBtn').click(function() {
        $('#dnsOffcanvas').removeClass('show');
    });


    $(document).on('click', function(e) {
        if (!$(e.target).closest('.edit_dns_link').length && !$(e.target).closest('#dnsOffcanvas').length) {
            $('#dnsOffcanvas').removeClass('show');
        }
    });
});


</script>




{% else %}
<div class="page page-center">
      <div class="container-tight py-4">
        <div class="empty">
          <div class="empty-header">No Domains</div>
          <p class="empty-title">No domains yet.</p>
        </div>
      </div>
    </div>
{% endif %}
</div>











   <div class="modal modal-blur fade" id="modal-add-domain" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add new domain to User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-lg-8">
                <div class="mb-3">
                  <label class="form-label">Domain Name</label>
                  <div class="input-group ">
                    <input type="text" class="form-control ps-0"  value="" autocomplete="on">
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="mb-3">
                  <label class="form-label">User</label>
                  <select class="form-select">
                    <option value="1" selected>Private</option>
                    <option value="2">Public</option>
                    <option value="3">Hidden</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">
              Cancel
            </a>
            <a href="#" class="btn btn-primary ms-auto" data-bs-dismiss="modal">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
              Add Domain to User
            </a>
          </div>
        </div>
      </div>
    </div>






<!--script src="{{ url_for('static', filename='pages/domains.js') }}" defer></script-->

{% endblock %}
